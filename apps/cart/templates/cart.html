{% extends 'base.html' %}
 
<!-- Template title -->
{% block title %} Checkout {% endblock %}
 
<!-- Template content -->
{% block content %}
   <div id="cartapp">
      <!-- shows cart items or empty cart message -->
         <h1 class="title"> Checkout </h1>
          <!-- when an item is in the cart -->
         {% if cart_details %}
            <!-- table to display cart information -->
            <div v-if="products.length > 0">
               <div class="table">
                  <table class="table">
                     <!-- table headers -->
                     <thead>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price </th>
                        <th></th>
                     </thead>
                     <tbody>
                        <!-- the product information is shown in the table -->
                        <tr v-for="product in products">
                           <td>[[ product.title ]]</td>
                           <td><button @click="decreaseQuantity(product.id, product.quantity, product.price)">-</button> [[ product.quantity ]] <button @click="increaseQuantity(product.id, product.quantity, product.price)">+</button></td>
                           <td> £ [[ product.total ]]</td>
                           <td><button @click="deleteFromCart(product.id)">Remove</button></td>
                        </tr>
                     </tbody>
                     <tfoot>
                        <tr>
                           <td> Total: </td>
                           <!-- total number of items -->
                           <td> [[ numItems ]]</td>
                           <!-- total cost-->
                           <td> £ [[ totalCost ]]</td>
                        </tr>
                     </tfoot>
                  </table>
               </div>
               <!-- checkout form is submitted -->
               <form v-on:submit.prevent="submitForm()">
                  <div class="field">

                  <!-- Firsy name field -->
                     <div class="control">
                        <label> First name </label>
                        <input type="text" name="first_name" v-model="first_name">
                     </div>
                  </div>

                  <!-- Last name field -->
                  <div class="field">
                     <div class="control">
                        <label> Last name </label>
                        <input type="text" name="last_name" v-model="last_name">
                     </div>
                  </div>

                  <!-- Email field -->
                  <div class="field">
                     <div class="control">
                        <label> Email </label>
                        <input type="text" name="email" v-model="email">
                     </div>
                  </div>

                  <!-- Address field -->
                  <div class="field">
                     <div class="control">
                        <label> Address </label>
                        <input type="text" name="address" v-model="address">
                     </div>
                  </div>

                  <!-- Postcode field -->
                  <div class="field">
                     <div class="control">
                        <label> Postcode </label>
                        <input type="text" name="postcode" v-model="postcode">
                     </div>
                  </div>

                  <!-- City field -->
                  <div class="field">
                     <div class="control">
                        <label> City </label>
                        <input type="text" name="city" v-model="city">
                     </div>
                  </div>

                  <!-- Check out button -->
                  <div class="field">
                     <div class="control">
                        <button class="button is-primary">Check out</button>
                     </div>
                  </div>
               </form>
            </div>
            <!-- when no products are in the cart the empty card message shows -->
            <p v-else="">Your cart is empty !</p>
         {% else %}
            <p> Your cart is empty !</p>
         {% endif %}
   </div>
{% endblock %}

<!-- creates vue app -->
{% block scripts %}
<script>
   var productsapp = new Vue({
      el: '#cartapp',
      delimiters: ['[[',']]'],
      store: store,
      data () {
         return {
            first_name: '',
            last_name: '',
            email: '',
            address: '',
            postcode: '',
            city: '',
            products: [{{ productstring|safe }}]
         }
      },
      // calculates number of items and total costs
      computed:{
         numItems: function() {
            return store.state.numItems
         },
         totalCost: function() {
            return store.state.totalCost
         }
      },
      // product id is sent to api and this data is fetched to display the is increased quantity in the cart or an error is displayed
      methods: {
         submitForm() {
            console.log('Form Submitted');

            var data = {
               'first_name': this.first_name,
               'last_name': this.last_name,
               'email': this.email,
               'address': this.address,
               'postcode': this.postcode,
               'city': this.city
            };
            // fetch chekout api
            fetch('/api/checkout/', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
               },
               credentials: 'same-origin',
               body: JSON.stringify(data)
            })
            .then((response) =>{
               console.log('Success');
               console.log(response);

               window.location.href = '/'
            })
            .catch(function (error){
               console.log('Error 2');
               console.log(error);
            })
         },
         // fucntion to increase cart quantity
         increaseQuantity(product_id, quantity, price) {
               console.log('Product_id:', product_id)

            var data = {'product_id': product_id, 'update': true, 'quantity': parseInt(quantity)+ 1};

            store.commit('increase', 1);
            store.commit('UpdateTotal', parseFloat(price));
            
            // add to cart api is fetched to update cart data
            fetch('/api/add_to_cart/', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
               },
               credentials: 'same-origin',
               body: JSON.stringify(data)
            })
            .then((response) =>{
               console.log(response)

               for (var i = 0; i < this.products.length; i++){
                  var product = this.products[i];

                  if (product.id === product_id){
                     // auto updates quantity
                     this.products[i].quantity = parseInt(this.products[i].quantity) + 1;
                     
                     // auto updates prices
                     this.products[i].total = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
                  }
               }
            })
            .catch(function (error){
               console.log('Error 1');
               console.log(error);
            })

         },

         // decrease quantity for items in the cart
         decreaseQuantity(product_id, quantity, price) {
            console.log('Product_id:', product_id)

            var data = {
               'product_id': product_id, 
               'update': true, 
               'quantity': parseInt(quantity)- 1
            };

            // if quanity is zero, item is removed from basket
            if (parseInt(quantity) - 1 === 0) {
               this.deleteFromCart(product_id);
            } else {

               store.commit('increase', -1);
               store.commit('UpdateTotal', -parseFloat(price));
         
               fetch('/api/add_to_cart/', {
                  method: 'POST',
                  headers: {
                     'Content-Type': 'application/json',
                     'X-CSRFToken': '{{ csrf_token }}'
                  },
                  credentials: 'same-origin',
                  body: JSON.stringify(data)
               })
               .then((response) =>{
                  console.log(response)

                  for (var i = 0; i < this.products.length; i++){
                     var product = this.products[i];

                     if (product.id === product_id){
                        // auto updates quantity
                        this.products[i].quantity = parseInt(this.products[i].quantity) - 1;
                        
                        // auto updates prices
                        this.products[i].total = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
                     }
                  }
               })
               .catch(function (error){
                  console.log('Error 1');
                  console.log(error);
               })
            }
         },

         // product id is sent to api and this data is fetched from the api, the product is then removed from cart or an error is displayed
         deleteFromCart(product_id) {
            console.log('Remove product_id:', product_id)

         
            var data = {'product_id': product_id, 'update': false, 'quantity': 1}
            fetch('/api/delete_from_cart/', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken':'{{ csrf_token}}'
               },
               credentials: 'same-origin',
               body: JSON.stringify(data)
            })
            .then((response) =>{
               console.log(response)

               this.products = this.products.filter(product => product.id !== product_id)
            })
            .catch(function (error){
               console.log('Error 2');
               console.log(error);
            })
         }
      }
   });
</script>
{% endblock %}